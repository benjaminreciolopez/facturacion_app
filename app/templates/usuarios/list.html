{% extends "base.html" %} {% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Usuarios de la empresa</h2>

  <button class="btn btn-primary" onclick="nuevoUsuario()">
    Añadir usuario
  </button>
</div>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Email</th>
      <th>Rol</th>
      <th>Estado</th>
      <th style="width: 220px">Acciones</th>
    </tr>
  </thead>

  <tbody id="tablaUsuarios">
    {% for u in usuarios %}
    <tr id="row-{{ u.id }}">
      <td>{{ u.email }}</td>
      <td>{{ u.rol }}</td>

      <td>
        {% if u.activo %}
        <span class="text-success">Activo</span>
        {% else %}
        <span class="text-danger">Inactivo</span>
        {% endif %}
      </td>

      <td>
        {% if u.id != request.session.get("user").id %}
        <a href="/usuarios/{{ u.id }}/toggle" class="btn btn-sm btn-warning">
          {{ "Desactivar" if u.activo else "Activar" }}
        </a>

        <button
          class="btn btn-danger btn-sm ms-2 eliminar-btn"
          data-user-id="{{ u.id }}"
        >
          Eliminar
        </button>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  /* ===========================
   CREAR USUARIO
=========================== */
  async function nuevoUsuario() {
    const { value: formValues } = await Swal.fire({
      title: "Nuevo usuario",
      html: `
      <input id="email" class="swal2-input" placeholder="Email">
      <input id="password" type="password" class="swal2-input" placeholder="Contraseña">

      <select id="rol" class="swal2-input">
        <option value="user">Usuario</option>
        <option value="admin">Administrador</option>
      </select>
    `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: "Crear usuario",
      cancelButtonText: "Cancelar",
      preConfirm: () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const rol = document.getElementById("rol").value;

        if (!email || !password) {
          Swal.showValidationMessage("Email y contraseña obligatorios");
          return false;
        }

        return { email, password, rol };
      },
    });

    if (!formValues) return;

    const resp = await fetch("/usuarios/crear", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(formValues),
    });

    if (!resp.ok) {
      Swal.fire("Error", "No se pudo crear el usuario", "error");
      return;
    }

    Swal.fire({
      icon: "success",
      title: "Usuario creado",
      timer: 1200,
      showConfirmButton: false,
    });

    // Recargar lista rápido o podríamos AJAX real
    setTimeout(() => location.reload(), 1200);
  }

  /* ===========================
   ELIMINAR USUARIO
=========================== */
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".eliminar-btn");
    if (!btn) return;

    const id = btn.dataset.userId;

    const confirm = await Swal.fire({
      title: "¿Eliminar usuario?",
      text: "Esta acción eliminará el usuario definitivamente",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "Cancelar",
    });

    if (!confirm.isConfirmed) return;

    const resp = await fetch(`/usuarios/${id}/delete`, { method: "POST" });

    const data = await resp.json();

    if (!resp.ok || !data.ok) {
      Swal.fire("Error", "No se pudo eliminar el usuario", "error");
      return;
    }

    const fila = document.getElementById("row-" + id);
    if (fila) fila.remove();

    Swal.fire({
      title: "Usuario eliminado",
      icon: "success",
      timer: 1200,
      showConfirmButton: false,
    });
  });
</script>

{% endblock %}
