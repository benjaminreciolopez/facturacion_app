{% extends "base.html" %} {% block content %}

<h2>Usuarios de la empresa</h2>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Email</th>
      <th>Rol</th>
      <th>Estado</th>
      <th style="width: 220px">Acciones</th>
    </tr>
  </thead>

  <tbody id="tablaUsuarios">
    {% for u in usuarios %}
    <tr id="row-{{ u.id }}">
      <td>{{ u.email }}</td>
      <td>{{ u.rol }}</td>

      <td>
        {% if u.activo %}
        <span class="text-success">Activo</span>
        {% else %}
        <span class="text-danger">Inactivo</span>
        {% endif %}
      </td>

      <td>
        {% if u.id != request.session.get("user").id %}
        <a href="/usuarios/{{ u.id }}/toggle" class="btn btn-sm btn-warning">
          {{ "Desactivar" if u.activo else "Activar" }}
        </a>

        <button
          class="btn btn-danger btn-sm ms-2 eliminar-btn"
          data-user-id="{{ u.id }}"
        >
          Eliminar
        </button>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".eliminar-btn");
    if (!btn) return;

    const id = btn.dataset.userId;

    const confirm = await Swal.fire({
      title: "¿Eliminar usuario?",
      text: "Esta acción desactivará el usuario",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "Cancelar",
    });

    if (!confirm.isConfirmed) return;

    const resp = await fetch(`/usuarios/${id}/delete`, {
      method: "POST",
    });

    if (!resp.ok) {
      Swal.fire("Error", "No se pudo eliminar el usuario", "error");
      return;
    }

    const data = await resp.json();
    if (!data.ok) {
      Swal.fire("Error", "No se pudo eliminar el usuario", "error");
      return;
    }

    // eliminar fila sin recargar
    const fila = document.getElementById("row-" + id);
    if (fila) fila.remove();

    Swal.fire({
      title: "Usuario eliminado",
      icon: "success",
      timer: 1200,
      showConfirmButton: false,
    });
  });
</script>

{% endblock %}
