{% extends "base.html" %} {% block content %}

<h2 class="mb-1">Almacenamiento del servidor</h2>
<p class="text-muted">Ubicación actual: {{ path }}</p>

<!-- BREADCRUMB -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    {% for b in breadcrumb %}
    <li class="breadcrumb-item">
      <a href="/storage/ui?path={{ b.ruta }}">{{ b.nombre }}</a>
    </li>
    {% endfor %}
  </ol>
</nav>

<table class="table table-hover align-middle">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Tipo</th>
      <th>Tamaño</th>
      <th class="text-end">Acciones</th>
    </tr>
  </thead>

  <tbody>
    {% for f in elementos %}
    <tr
      class="fila-explorer"
      data-path="{{ f.ruta }}"
      data-isdir="{{ '1' if f.es_dir else '0' }}"
    >
      <td>
        {% if f.es_dir %}
        <i class="bi bi-folder-fill text-warning me-2"></i>
        {% else %}
        <i class="bi bi-file-earmark-text text-secondary me-2"></i>
        {% endif %} {{ f.nombre }}
      </td>

      <td>{{ f.tipo }}</td>

      <td>
        {% if f.tamano %} {{ "%.1f"|format(f.tamano / 1024) }} KB {% else %} -
        {% endif %}
      </td>

      <td class="text-end">
        {% if not f.es_dir %}
        <a
          href="/storage/view?path={{ f.ruta }}"
          class="btn btn-sm btn-outline-primary"
          target="_blank"
          >Ver</a
        >
        <a
          href="/storage/download?path={{ f.ruta }}"
          class="btn btn-sm btn-success"
          >Descargar</a
        >
        {% endif %}

        <button
          class="btn btn-sm btn-danger ms-1 btn-delete"
          data-path="{{ f.ruta }}"
        >
          Eliminar
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<script>
  async function cargarStorage() {
    const res = await fetch("/storage", { credentials: "include" });
    const data = await res.json();

    const tbody = document.getElementById("storageTable");
    tbody.innerHTML = "";

    data.items.forEach((item) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
      <td>${item.ruta}</td>
      <td>${item.tipo === "dir" ? "Carpeta" : "Archivo"}</td>
      <td>${item.tamano ? (item.tamano / 1024).toFixed(1) + " KB" : "-"}</td>

      <td class="text-end">

      ${
        item.tipo === "file"
          ? `
        <a class="btn btn-sm btn-outline-primary" target="_blank"
          href="/data/${item.ruta}">
          Ver
        </a>

        <a class="btn btn-sm btn-success"
          href="/storage/download?path=${item.ruta}">
          Descargar
        </a>
        `
          : ""
      }

        <button class="btn btn-sm btn-danger"
          onclick="eliminar('${item.ruta}')">
          Eliminar
        </button>
      </td>
    `;

      tbody.appendChild(tr);
    });
  }

  async function eliminar(path) {
    if (!confirm("¿Eliminar " + path + "?")) return;

    await fetch("/storage?path=" + path, {
      method: "DELETE",
      credentials: "include",
    });

    cargarStorage();
  }

  document.addEventListener("DOMContentLoaded", cargarStorage);
</script>
<script>
  document.querySelectorAll(".fila-explorer").forEach((row) => {
    row.addEventListener("dblclick", () => {
      const isDir = row.dataset.isdir === "1";
      const path = row.dataset.path;

      if (isDir) {
        window.location.href = `/storage/ui?path=${encodeURIComponent(path)}`;
      }
    });
  });
</script>

{% endblock %}
