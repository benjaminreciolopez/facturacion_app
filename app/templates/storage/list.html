{% extends "base.html" %} {% block content %}

<h2>Almacenamiento del servidor</h2>

<p class="text-muted">Ubicación: <strong>/data</strong></p>

<table class="table table-hover">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Tipo</th>
      <th>Tamaño</th>
      <th class="text-end">Acciones</th>
    </tr>
  </thead>

  <tbody id="storageTable"></tbody>
</table>

<script>
  async function cargarStorage() {
    const res = await fetch("/storage", { credentials: "include" });
    const data = await res.json();

    const tbody = document.getElementById("storageTable");
    tbody.innerHTML = "";

    data.items.forEach((item) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
      <td>${item.ruta}</td>
      <td>${item.tipo === "dir" ? "Carpeta" : "Archivo"}</td>
      <td>${item.tamano ? (item.tamano / 1024).toFixed(1) + " KB" : "-"}</td>

      <td class="text-end">

      ${
        item.tipo === "file"
          ? `
        <a class="btn btn-sm btn-outline-primary" target="_blank"
          href="/data/${item.ruta}">
          Ver
        </a>

        <a class="btn btn-sm btn-success"
          href="/storage/download?path=${item.ruta}">
          Descargar
        </a>
        `
          : ""
      }

        <button class="btn btn-sm btn-danger"
          onclick="eliminar('${item.ruta}')">
          Eliminar
        </button>
      </td>
    `;

      tbody.appendChild(tr);
    });
  }

  async function eliminar(path) {
    if (!confirm("¿Eliminar " + path + "?")) return;

    await fetch("/storage?path=" + path, {
      method: "DELETE",
      credentials: "include",
    });

    cargarStorage();
  }

  document.addEventListener("DOMContentLoaded", cargarStorage);
</script>

{% endblock %}
