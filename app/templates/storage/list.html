{% extends "base.html" %} {% block content %}

<h2 class="mb-1">Almacenamiento del servidor</h2>
<p class="text-muted">Ubicación actual: {{ path }}</p>

<!-- ================= BREADCRUMB ================ -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    {% for b in breadcrumb %} {% if loop.last %}
    <li class="breadcrumb-item active" aria-current="page">{{ b.nombre }}</li>
    {% else %}
    <li class="breadcrumb-item">
      <a href="/storage/ui?path={{ b.ruta }}">{{ b.nombre }}</a>
    </li>
    {% endif %} {% endfor %}
  </ol>
</nav>

<!-- ================= LISTADO ================= -->
<table class="table table-hover align-middle" id="storageTable">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Tipo</th>
      <th>Tamaño</th>
      <th class="text-end">Acciones</th>
    </tr>
  </thead>

  <tbody>
    {% for f in elementos %}
    <tr
      class="fila-explorer"
      data-path="{{ f.ruta }}"
      data-isdir="{{ '1' if f.es_dir else '0' }}"
    >
      <td>
        {% if f.es_dir %}
        <i class="bi bi-folder-fill text-warning me-2"></i>
        {% else %}
        <i class="bi bi-file-earmark-text text-secondary me-2"></i>
        {% endif %} {{ f.nombre }}
      </td>

      <td>{{ f.tipo }}</td>

      <td>
        {% if f.tamano %} {{ "%.1f"|format(f.tamano / 1024) }} KB {% else %} -
        {% endif %}
      </td>

      <td class="text-end acciones" style="visibility: hidden">
        {% if not f.es_dir %}
        <a
          href="/storage/view?path={{ f.ruta }}"
          target="_blank"
          class="btn btn-sm btn-outline-primary"
          >Ver</a
        >

        <a
          href="/storage/download?path={{ f.ruta }}"
          class="btn btn-sm btn-success"
          >Descargar</a
        >
        {% endif %}

        <button
          class="btn btn-sm btn-danger btn-delete"
          data-path="{{ f.ruta }}"
        >
          Eliminar
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<style>
  .fila-explorer.selected {
    background: #e8f2ff !important;
    box-shadow: inset 0 0 0 2px #3b82f6;
  }
</style>

<script>
  /* =========================
   Selección estilo Explorer
========================= */

  const filas = document.querySelectorAll(".fila-explorer");
  let seleccionada = null;

  filas.forEach((row) => {
    // click → seleccionar
    row.addEventListener("click", () => {
      if (seleccionada) seleccionada.classList.remove("selected");
      document
        .querySelectorAll(".acciones")
        .forEach((a) => (a.style.visibility = "hidden"));

      seleccionada = row;
      row.classList.add("selected");

      const acciones = row.querySelector(".acciones");
      if (acciones) acciones.style.visibility = "visible";
    });

    // doble click → abrir
    row.addEventListener("dblclick", () => {
      const isDir = row.dataset.isdir === "1";
      const path = row.dataset.path;

      if (isDir) {
        window.location.href = `/storage/ui?path=${encodeURIComponent(path)}`;
      } else {
        window.open(`/storage/view?path=${encodeURIComponent(path)}`, "_blank");
      }
    });
  });

  /* =========================
   Eliminar archivo / carpeta
========================= */

  document.querySelectorAll(".btn-delete").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      e.stopPropagation();

      const path = btn.dataset.path;
      if (!confirm("¿Eliminar " + path + "?")) return;

      await fetch(`/storage?path=${encodeURIComponent(path)}`, {
        method: "DELETE",
        credentials: "include",
      });

      window.location.reload();
    });
  });
</script>

{% endblock %}
