{% extends "base.html" %} {% block content %}

<!-- ================= ALMACENAMIENTO ================= -->
<div class="mt-3 mb-4 p-3 bg-white border rounded shadow-sm">
  <div class="d-flex justify-content-between align-items-center">
    <strong>Almacenamiento del servidor</strong>

    <span>
      {{ (usage.used / 1024 / 1024) | round(2) }} MB / {{ (usage.total / 1024 /
      1024) | round(0) }} MB
    </span>
  </div>

  {# Normalizamos el porcentaje para la barra #} {% set raw = usage.percent if
  usage and usage.percent is not none else 0 %} {% set p = raw|int %} {% if p <
  0 %}{% set p = 0 %}{% endif %} {% if p > 100 %}{% set p = 100 %}{% endif %}

  <div class="progress mt-2" style="height: 18px">
    <div
      class="progress-bar {% if p < 70 %}bg-success{% elif p < 90 %}bg-warning{% else %}bg-danger{% endif %}"
      role="progressbar"
      style="width: {{ p }}%;"
      aria-valuenow="{{ p }}"
      aria-valuemin="0"
      aria-valuemax="100"
    >
      {{ p }}%
    </div>
  </div>
</div>

<!-- ================= OPCIONES ================= -->
<div class="d-flex justify-content-between align-items-center my-3">
  <a
    href="/storage/ui?path={{ path }}&show_hidden={{ not show_hidden }}"
    class="btn btn-outline-secondary btn-sm"
  >
    {% if show_hidden %} Ocultar archivos del sistema {% else %} Mostrar
    archivos del sistema {% endif %}
  </a>

  <a href="/storage/trash/ui" class="btn btn-outline-dark btn-sm"> Papelera </a>
</div>

{% if trash_view %}
<div class="alert alert-warning">
  Estás viendo la papelera. Los elementos aquí pueden restaurarse o eliminarse
  definitivamente.
</div>

<div class="text-end mb-3">
  <button id="vaciarTrash" class="btn btn-danger">Vaciar papelera</button>
</div>
{% endif %}

<!-- ================= TÍTULO ================= -->
<h2 class="mb-1">Almacenamiento del servidor</h2>
<p class="text-muted">Ubicación actual: {{ path }}</p>

<!-- ================= BREADCRUMB ================= -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    {% for b in breadcrumb %} {% if loop.last %}
    <li class="breadcrumb-item active" aria-current="page">{{ b.nombre }}</li>
    {% else %}
    <li class="breadcrumb-item">
      <a href="/storage/ui?path={{ b.ruta }}">{{ b.nombre }}</a>
    </li>
    {% endif %} {% endfor %}
  </ol>
</nav>

<!-- ================= BARRA DE ACCIONES (SELECCIÓN) ================= -->
<div
  id="actionBar"
  class="alert alert-primary d-none justify-content-between align-items-center"
>
  <span id="selectedCount">0 elementos seleccionados</span>

  <div class="btn-group btn-group-sm" role="group">
    {% if trash_view %}
    <button id="restoreSelected" class="btn btn-success">Restaurar</button>
    <button id="deletePermanent" class="btn btn-danger">
      Eliminar definitivo
    </button>
    {% else %}
    <button id="downloadZip" class="btn btn-primary">Descargar ZIP</button>
    <button id="deleteSelected" class="btn btn-danger">
      Enviar a papelera
    </button>
    {% endif %}
    <button id="cancelSelection" class="btn btn-secondary">Cancelar</button>
  </div>
</div>

<!-- ================= LISTADO ================= -->
<table class="table table-hover align-middle" id="storageTable">
  <thead>
    <tr>
      <th style="width: 40px">
        <input type="checkbox" id="checkAll" />
      </th>
      <th>Nombre</th>
      <th>Tipo</th>
      <th>Tamaño</th>
    </tr>
  </thead>

  <tbody>
    {% for f in elementos %}
    <tr
      class="fila-explorer"
      data-path="{{ f.ruta }}"
      data-isdir="{{ '1' if f.es_dir else '0' }}"
    >
      <td>
        <input type="checkbox" class="check-row" />
      </td>

      <td>
        {% if f.es_dir %}
        <i class="bi bi-folder-fill text-warning me-2"></i>
        {% else %}
        <i class="bi bi-file-earmark-text text-secondary me-2"></i>
        {% endif %} {{ f.nombre }}
      </td>

      <td>{{ f.tipo }}</td>

      <td>
        {% if f.tamano %} {{ "%.1f"|format(f.tamano / 1024) }} KB {% else %} -
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ================= ESTILOS ================= -->
<style>
  #storageTable tbody tr:nth-child(even) {
    background: #fafafa;
  }

  .fila-explorer {
    cursor: pointer;
    user-select: none;
  }

  .fila-explorer.selected {
    background: #e8f2ff !important;
    box-shadow: inset 0 0 0 2px #3b82f6;
  }

  @media (max-width: 768px) {
    #storageTable td {
      padding: 10px 4px;
      font-size: 14px;
    }

    #actionBar {
      position: sticky;
      bottom: 0;
      z-index: 50;
    }

    .breadcrumb {
      font-size: 13px;
    }
  }
</style>

<!-- ================= JS ================= -->

<script>
  // ======================
  //   FLAGS DE ENTORNO
  // ======================

  // ======================
  //   UTILIDADES
  // ======================
  async function postJSON(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      const text = await res.text();
      alert("Error " + res.status + ":\n" + text);
      throw new Error("HTTP " + res.status);
    }
    return res;
  }

  function getSelected() {
    return [...document.querySelectorAll(".check-row:checked")]
      .map((c) => c.closest("tr")?.dataset.path)
      .filter(Boolean);
  }

  function updateSelectionUI() {
    const actionBar = document.getElementById("actionBar");
    const selectedCount = document.getElementById("selectedCount");
    const selected = getSelected();

    if (!actionBar || !selectedCount) return;

    if (selected.length === 0) {
      actionBar.classList.add("d-none");
    } else {
      actionBar.classList.remove("d-none");
    }

    selectedCount.innerText = selected.length + " elementos seleccionados";
  }
</script>

<script>
  // ======================
  //   SELECCIÓN
  // ======================
  const filas = document.querySelectorAll(".fila-explorer");
  const checkAll = document.getElementById("checkAll");
  const IS_TRASH_VIEW = document.body.dataset.trash === "1";

  function refreshRowSelectionVisual() {
    document.querySelectorAll(".fila-explorer").forEach((row) => {
      const cb = row.querySelector(".check-row");
      if (cb && cb.checked) row.classList.add("selected");
      else row.classList.remove("selected");
    });
  }

  // Individual
  document.querySelectorAll(".check-row").forEach((c) => {
    c.addEventListener("change", () => {
      refreshRowSelectionVisual();
      updateSelectionUI();
    });
  });

  // Select all
  checkAll?.addEventListener("change", () => {
    document.querySelectorAll(".check-row").forEach((c) => {
      c.checked = checkAll.checked;
    });

    refreshRowSelectionVisual();
    updateSelectionUI();
  });

  // ESC limpia selección
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      document
        .querySelectorAll(".check-row")
        .forEach((c) => (c.checked = false));

      if (checkAll) checkAll.checked = false;

      refreshRowSelectionVisual();
      updateSelectionUI();
    }
  });

  // Doble clic abre (solo fuera de papelera)
  filas.forEach((row) => {
    row.addEventListener("dblclick", () => {
      const isDir = row.dataset.isdir === "1";
      const path = row.dataset.path;

      if (isDir) {
        window.location.href = `/storage/ui?path=${encodeURIComponent(path)}`;
      } else if (!IS_TRASH_VIEW) {
        window.open(`/storage/view?path=${encodeURIComponent(path)}`, "_blank");
      }
    });
  });

  // Cancelar
  document.getElementById("cancelSelection")?.addEventListener("click", () => {
    document.querySelectorAll(".check-row").forEach((c) => (c.checked = false));

    if (checkAll) checkAll.checked = false;

    refreshRowSelectionVisual();
    updateSelectionUI();
  });
</script>

<script>
  // ---------- ACCIONES NORMAL ----------
  document
    .getElementById("deleteSelected")
    ?.addEventListener("click", async () => {
      const paths = getSelected();
      if (!paths.length) return alert("Selecciona al menos un elemento.");

      if (!confirm("¿Enviar a papelera " + paths.length + " elementos?"))
        return;

      await postJSON("/storage/batch/delete", { paths });
      location.reload();
    });

  document
    .getElementById("downloadZip")
    ?.addEventListener("click", async () => {
      const paths = getSelected();
      if (!paths.length)
        return alert("Selecciona al menos un archivo o carpeta.");

      const res = await postJSON("/storage/batch/zip", { paths });

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "backup_storage.zip";
      document.body.appendChild(a);
      a.click();
      a.remove();

      window.URL.revokeObjectURL(url);
    });
</script>
<script>
  // ---------- ACCIONES PAPELERA ----------
  document
    .getElementById("restoreSelected")
    ?.addEventListener("click", async () => {
      const paths = getSelected();
      if (!paths.length) return alert("Selecciona al menos un elemento.");

      if (!confirm("¿Restaurar " + paths.length + " elementos?")) return;

      await postJSON("/storage/trash/batch-restore", { paths });
      location.reload();
    });

  document
    .getElementById("deletePermanent")
    ?.addEventListener("click", async () => {
      const paths = getSelected();
      if (!paths.length) return alert("Selecciona al menos un elemento.");

      if (
        !confirm(
          "ELIMINACIÓN DEFINITIVA\n\n" +
            paths.length +
            " elementos.\n\nEsto NO se puede deshacer."
        )
      )
        return;

      await postJSON("/storage/trash/batch-delete", { paths });
      location.reload();
    });

  document
    .getElementById("vaciarTrash")
    ?.addEventListener("click", async () => {
      if (
        !confirm("¿Vaciar papelera definitivamente?\nNo podrás recuperar nada.")
      )
        return;

      await fetch(`/storage/trash/empty`, {
        method: "DELETE",
        credentials: "include",
      });

      location.reload();
    });
</script>
{% endblock %}
