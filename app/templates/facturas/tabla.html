{% for f in facturas %} {% set es_rectificativa = f.numero and
f.numero.endswith('R') %} {% set aud = auditoria_counts.get(f.id) %} {% set
aud_total = (aud.ok + aud.bloqueado + aud.error) if aud else 0 %} {% set fiscal
= resumen_fiscal.get(f.id) %}

<tr
  data-factura='{{ {
        "id": f.id,
        "numero": f.numero,
        "cliente": (f.cliente.nombre if f.cliente else "-"),
        "fecha": (f.fecha.isoformat() if f.fecha else None),
        "total": f.total,
        "estado": f.estado,
        "ruta_pdf": f.ruta_pdf
      } | tojson | safe }}'
>
  <!-- NÂº -->
  <td>{{ f.numero or "Borrador" }}</td>

  <!-- Cliente -->
  <td>{{ f.cliente.nombre if f.cliente else "-" }}</td>

  <!-- Fecha -->
  <td>
    {% if f.fecha %} {{ f.fecha.strftime("%d/%m/%Y") }} {% else %} - {% endif %}
  </td>

  <!-- Estado + VeriFactu + EnvÃ­o email -->
  <td>
    {% if f.estado == "BORRADOR" %}
    <span class="badge bg-secondary">Borrador</span>

    {% elif f.estado == "VALIDADA" %}
    <div class="d-flex flex-column align-items-start gap-1">
      <span class="badge bg-success">Validada</span>

      {# VeriFactu solo si verifactu_ok #} {% if verifactu_ok.get(f.id) %}
      <span class="text-success small d-inline-flex align-items-center gap-1">
        <span class="verifactu-dot"></span>
        VeriFactu
      </span>
      {% endif %} {# Enviada por email #} {% if enviada_email.get(f.id) %}
      <span class="text-primary small d-inline-flex align-items-center gap-1">
        ðŸ“§ Enviada al cliente
      </span>
      {% endif %}
    </div>

    {% elif f.estado == "ANULADA" %}
    <span class="badge bg-danger">Anulada</span>

    {% else %} {{ f.estado }} {% endif %}
  </td>

  <!-- Total -->
  <td>{{ "%.2f"|format(f.total) }} â‚¬</td>

  <!-- Estado fiscal resumen -->
  <td>
    {% if fiscal %} {% if fiscal.estado == "OK" %}
    <span class="badge bg-success">OK</span>
    {% elif fiscal.estado == "ADVERTENCIA" %}
    <span class="badge bg-warning text-dark">Advertencia</span>
    {% elif fiscal.estado == "ERROR" %}
    <span class="badge bg-danger">Error</span>
    {% endif %} {% else %}
    <span class="text-muted">â€”</span>
    {% endif %}
  </td>

  <!-- Acciones -->
  <td class="acciones text-end" style="visibility: hidden">
    <div class="acciones-wrap">
      {# ========================= ESTADO: BORRADOR ==========================
      #} {% if f.estado == "BORRADOR" %}

      <a href="/facturas/{{ f.id }}/edit" class="btn btn-sm btn-primary">
        Editar
      </a>

      <a
        href="/facturas/{{ f.id }}/delete"
        class="btn btn-sm btn-outline-danger"
        onclick="return confirm('Â¿Eliminar factura en borrador?');"
      >
        Eliminar
      </a>

      <button
        type="button"
        class="btn btn-sm btn-success btn-validar"
        data-id="{{ f.id }}"
      >
        Validar
      </button>

      {# ========================= ESTADO: VALIDADA ==========================#}
      {% elif f.estado == "VALIDADA" %} {% if pdf_existencia.get(f.id) %}
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary btn-ver-pdf"
        data-pdf="{{ f.ruta_pdf }}"
      >
        Ver PDF
      </button>
      {% else %}
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary btn-generar-pdf"
        data-id="{{ f.id }}"
      >
        Generar PDF
      </button>
      {% endif %}

      <button
        type="button"
        class="btn btn-sm btn-primary ms-1 btn-open-email"
        data-id="{{ f.id }}"
        data-email="{{ f.cliente.email if f.cliente and f.cliente.email else '' }}"
        data-numero="{{ f.numero or '' }}"
      >
        Enviar por email
      </button>

      {% if not es_rectificativa %}
      <button
        type="button"
        class="btn btn-sm btn-warning btn-anular"
        data-id="{{ f.id }}"
      >
        Anular
      </button>
      {% endif %} {# =========================
      ESTADO:ANULADA========================== #} {% elif f.estado == "ANULADA"
      %} {% if pdf_existencia.get(f.id) %}
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary btn-ver-pdf"
        data-pdf="{{ f.ruta_pdf }}"
      >
        Ver PDF
      </button>
      {% else %}
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary btn-generar-pdf"
        data-id="{{ f.id }}"
      >
        Generar PDF
      </button>
      {% endif %}

      <button
        type="button"
        class="btn btn-sm btn-outline-secondary ms-1 btn-open-email"
        data-id="{{ f.id }}"
        data-email="{{ f.cliente.email if f.cliente and f.cliente.email else '' }}"
        data-numero="{{ f.numero or '' }}"
      >
        Enviar por email
      </button>

      <hr class="my-1" />

      <a
        href="/auditoria?entidad=FACTURA&entidad_id={{ f.id }}"
        class="btn btn-sm btn-outline-dark"
      >
        AuditorÃ­a{% if aud_total > 0 %} ({{ aud_total }}){% endif %}
      </a>

      {% endif %}
    </div>
  </td>
</tr>
{% endfor %} {% if facturas|length == 0 %}
<tr>
  <td colspan="7" class="text-center text-muted">No hay facturas aÃºn</td>
</tr>
{% endif %}
