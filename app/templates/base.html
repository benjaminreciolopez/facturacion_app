<!DOCTYPE html>
<html lang="es">
  <head>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon" />

    <link rel="manifest" href="/static/manifest.json" />
    <meta name="theme-color" content="#2563eb" />

    <link rel="apple-touch-icon" href="/static/pwa/icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{{ title or "Facturación" }}</title>

    <link href="/static/style.css" rel="stylesheet" />

    <script src="/static/js/offline_db.js"></script>
    <script src="/static/js/offline_sync.js"></script>
    <script src="/static/htmx.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
  </head>

  <body
    class="bg-gray-100 text-gray-900 relative overflow-x-hidden min-h-screen"
  >
    <!-- DECOR -->
    <div
      class="absolute -top-28 -left-36 w-[500px] h-[500px] bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 rounded-full blur-3xl opacity-30"
    ></div>
    {% set u = get_user(request) %}

    <!-- ======================= LAYOUT ======================= -->
    <div id="layout-wrapper" class="flex">
      <!-- ====================== SIDEBAR ====================== -->
      <aside
        id="sidebar"
        class="fixed top-0 left-0 h-full w-72 bg-white shadow-xl border-r border-gray-200/70 transform -translate-x-full transition-transform duration-300 z-50 p-6 overflow-y-auto"
      >
        <div class="absolute inset-0 pointer-events-none">
          <div
            class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-blue-200/40 via-indigo-300/35 to-transparent rounded-3xl blur-[35px]"
          ></div>

          <div
            class="absolute top-10 left-10 w-52 h-52 bg-indigo-500/35 rounded-[55%_45%_60%_40%] blur-[40px]"
          ></div>
        </div>

        <h1 class="text-xl font-bold mb-8 relative z-10 tracking-wide">
          FACTURACIÓN
        </h1>

        <nav class="flex flex-col space-y-3 relative z-10">
          {% if request.url.path != '/dashboard' %}
          <a href="/dashboard" class="nav-link">Dashboard</a>
          {% endif %} {% if u and u.rol == "admin" %}
          <a href="/usuarios" class="nav-link">Usuarios</a>
          {% endif %}

          <a href="/clientes" class="nav-link">Clientes</a>
          <a href="/conceptos" class="nav-link">Conceptos</a>
          <a href="/facturas" class="nav-link">Facturas</a>
          <a href="/informes" class="nav-link">Informes y Exportación</a>
          <a href="/auditoria" class="nav-link">Auditoría</a>
          {% if u and u.rol == "admin" %}
          <a href="/storage/ui" class="nav-link">Almacenamiento</a>
          {% endif %}
          <div class="relative mt-4 select-none" id="configMenu">
            <div
              id="configBtn"
              class="hover:text-blue-700 cursor-pointer flex items-center justify-between pr-2"
            >
              <span class="font-medium">Configuración</span>
              <span class="text-gray-500 transition" id="arrow">▾</span>
            </div>

            <div
              id="configSubmenu"
              class="hidden absolute left-0 top-7 w-60 bg-white/95 backdrop-blur-md border border-gray-200 shadow-2xl rounded-2xl p-1 z-50"
            >
              <a href="/configuracion/emisor" class="submenu-item"
                >Datos del emisor</a
              >
              <a href="/configuracion/iva" class="submenu-item"> IVA </a>
              <a href="/configuracion/sistema" class="submenu-item">
                Sistema
              </a>
            </div>
          </div>
        </nav>
      </aside>

      <!-- ====================== CONTENIDO ====================== -->
      <div class="flex-1 relative z-10">
        <!-- ================== HEADER ================== -->
        <header
          class="bg-white shadow flex justify-between items-center px-6 py-3"
        >
          <div class="flex items-center gap-3">
            <!-- BOTÓN SOLO MÓVIL -->
            <button id="openSidebar" class="text-3xl mr-2 focus:outline-none">
              ☰
            </button>

            <span class="font-semibold">Sistema Facturación</span>
          </div>

          <!-- Usuario -->
          {% if u %} {% set logo = get_emisor_logo() %}

          <div class="flex items-center gap-4">
            <div class="text-end">
              <div class="font-semibold">{{ u.email }}</div>
              <div class="text-gray-500 text-sm">{{ u.rol|upper }}</div>
            </div>

            <div class="relative">
              <button id="userMenuBtn" class="flex items-center">
                {% if logo %}
                <img
                  src="{{ logo }}"
                  class="h-10 w-10 rounded-full border shadow-sm object-cover"
                />
                {% else %}
                <i
                  class="bi bi-person-circle text-3xl text-gray-700 hover:text-blue-600"
                ></i>
                {% endif %}
              </button>

              <div
                id="userMenu"
                class="hidden absolute right-0 mt-2 w-44 bg-white shadow-xl rounded-lg border"
              >
                <a href="/perfil" class="block px-4 py-2 hover:bg-gray-100"
                  >Perfil</a
                >
                <hr />
                <a href="/logout" class="block px-4 py-2 hover:bg-gray-100"
                  >Cerrar sesión</a
                >
              </div>
            </div>
          </div>

          {% else %}
          <a
            href="/login"
            class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 shadow"
          >
            Iniciar sesión
          </a>

          <a
            href="/registro"
            class="px-4 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 shadow"
          >
            Registrarse
          </a>
          {% endif %}
        </header>

        <main class="p-10">{% block content %}{% endblock %}</main>
      </div>
    </div>

    <!-- ================= OVERLAY MÓVIL ================= -->
    <div
      id="sidebarOverlay"
      class="fixed inset-0 bg-black/40 hidden z-40"
    ></div>

    <!-- ================= SCRIPTS ================= -->

    <style>
      #configSubmenu {
        width: 260px;
        background: linear-gradient(
          135deg,
          rgba(127, 170, 240, 0.92),
          rgba(108, 110, 218, 0.92),
          rgba(144, 100, 219, 0.92)
        );
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.35);
        box-shadow: 0 25px 35px rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(18px);
        padding: 6px;
        transition: opacity 0.25s ease, transform 0.25s ease;
      }

      #configSubmenu.hidden {
        opacity: 0;
        visibility: hidden;
        transform: translateY(8px);
        pointer-events: none;
      }

      #configSubmenu:not(.hidden) {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .submenu-item {
        display: block;
        padding: 10px 14px;
        border-radius: 12px;
        color: white;
      }

      .submenu-item:hover {
        background: rgba(255, 255, 255, 0.18);
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Sidebar móvil -->
    <script>
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("sidebarOverlay");
      const openBtn = document.getElementById("openSidebar");

      function openMenu() {
        sidebar.classList.remove("-translate-x-full");
        overlay.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      function closeMenu() {
        sidebar.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
        document.body.style.overflow = "";
      }

      openBtn?.addEventListener("click", openMenu);
      overlay?.addEventListener("click", closeMenu);

      document.querySelectorAll("#sidebar a").forEach((a) => {
        a.addEventListener("click", closeMenu);
      });
    </script>

    <!-- Menú usuario -->
    <script>
      const userBtn = document.getElementById("userMenuBtn");
      const userMenu = document.getElementById("userMenu");

      userBtn?.addEventListener("click", () => {
        userMenu.classList.toggle("hidden");
      });

      document.addEventListener("click", (e) => {
        if (!userBtn?.contains(e.target) && !userMenu?.contains(e.target)) {
          userMenu?.classList.add("hidden");
        }
      });
    </script>

    <!-- Config submenu -->
    <script>
      const configBtn = document.getElementById("configBtn");
      const submenu = document.getElementById("configSubmenu");
      const arrow = document.getElementById("arrow");

      configBtn?.addEventListener("click", () => {
        submenu.classList.toggle("hidden");
        arrow.textContent = submenu.classList.contains("hidden") ? "▾" : "▴";
      });

      document.addEventListener("click", (e) => {
        if (!document.getElementById("configMenu").contains(e.target)) {
          submenu?.classList.add("hidden");
          arrow.textContent = "▾";
        }
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeMenu();
      });
    </script>
  </body>
</html>
